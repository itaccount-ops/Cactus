
// ============================================
// FINANCE MODULE (Invoices & Payments)
// ============================================

model Invoice {
  id            String        @id @default(cuid())
  number        String        @unique // INV-2024-001
  date          DateTime      @default(now())
  dueDate       DateTime
  status        InvoiceStatus @default(DRAFT)
  
  // Multi-tenant
  companyId     String?
  company       Company?      @relation(fields: [companyId], references: [id])
  
  // Relations
  clientId      String
  client        Client        @relation(fields: [clientId], references: [id])
  
  projectId     String?
  project       Project?      @relation(fields: [projectId], references: [id])
  
  // Amounts
  subtotal      Float         @default(0)
  taxAmount     Float         @default(0)
  total         Float         @default(0)
  currency      String        @default("EUR")
  
  // Payment tracking
  paidAmount    Float         @default(0)
  balance       Float         @default(0) // total - paidAmount
  
  // Metadata
  notes         String?       @db.Text
  terms         String?       @db.Text
  createdById   String
  createdBy     User          @relation(fields: [createdById], references: [id])
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  issuedAt      DateTime?     // When status changed to SENT
  paidAt        DateTime?     // When fully paid
  
  // Relations
  items         InvoiceItem[]
  payments      Payment[]
  
  @@index([companyId])
  @@index([clientId])
  @@index([projectId])
  @@index([status])
  @@index([dueDate])
  @@index([number])
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  description String
  quantity    Float   @default(1)
  unitPrice   Float
  taxRate     Float   @default(0) // Percentage (21 = 21%)
  
  // Calculated fields
  subtotal    Float   // quantity * unitPrice
  taxAmount   Float   // subtotal * (taxRate / 100)
  total       Float   // subtotal + taxAmount
  
  order       Int     @default(0) // Display order
  
  @@index([invoiceId])
}

model Payment {
  id          String        @id @default(cuid())
  amount      Float
  date        DateTime      @default(now())
  method      PaymentMethod @default(TRANSFER)
  reference   String?       // Transaction reference
  notes       String?
  
  invoiceId   String
  invoice     Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  createdById String
  createdBy   User          @relation(fields: [createdById], references: [id])
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([invoiceId])
  @@index([date])
}

enum InvoiceStatus {
  DRAFT       // Being created
  SENT        // Sent to client
  OVERDUE     // Past due date
  PAID        // Fully paid
  CANCELLED   // Cancelled
  PARTIAL     // Partially paid
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  CHEQUE
  OTHER
}
