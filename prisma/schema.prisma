generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model Company {
  id           String           @id @default(cuid())
  name         String
  slug         String           @unique
  logo         String?
  address      String?
  phone        String?
  email        String?
  website      String?
  taxId        String?
  currency     String           @default("EUR")
  timezone     String           @default("Europe/Madrid")
  isActive     Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  activityLogs ActivityLog[]
  clients      Client[]
  settings     CompanySettings?
  expenses     Expense[]
  invoices     Invoice[]
  leads        Lead[]
  products     Product[]
  projects     Project[]
  quotes       Quote[]
  taxRates     TaxRate[]
  teams        Team[]
  users        User[]

  @@index([slug])
}

model User {
  id                   String                 @id @default(cuid())
  name                 String
  email                String                 @unique
  image                String?
  passwordHash         String
  role                 Role                   @default(WORKER)
  department           Department             @default(OTHER)
  isDirective          Boolean                @default(false)
  companyId            String?
  dailyWorkHours       Float                  @default(8.0)
  isActive             Boolean                @default(true)
  canTrackHours        Boolean                @default(true)
  presenceStatus       PresenceStatus         @default(OFFLINE)
  presenceManual       Boolean                @default(false)
  lastActiveAt         DateTime?
  presenceExpiresAt    DateTime?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  preferences          Json?
  hourCost             Decimal?               @db.Decimal(10, 2)
  bankAccount          String?
  contractEndDate      DateTime?
  contractType         ContractType?
  emergencyContact     Json?
  employeeCode         String?                @unique
  hireDate             DateTime?
  salary               Decimal?               @db.Decimal(10, 2)
  ssNumber             String?
  vacationDays         Int                    @default(23)
  personalDays         Int                    @default(2)
  approvedAbsences     Absence[]              @relation("ApprovedAbsences")
  absences             Absence[]
  activityLogs         ActivityLog[]
  calendarItems        CalendarItem[]
  chatMemberships      ChatMember[]           @relation("ChatMemberships")
  uploadedDocuments    Document[]             @relation("UploadedDocuments")
  documentShares       DocumentShare[]
  documentVersions     DocumentVersion[]
  createdEvents        Event[]
  eventInvitations     EventAttendee[]
  position             String?
  expenses             Expense[]
  createdFolders       Folder[]
  createdInvoices      Invoice[]
  assignedLeads        Lead[]
  authoredMessages     Message[]              @relation("AuthoredMessages")
  sentNotifications    Notification[]         @relation("SentNotifications")
  notifications        Notification[]
  createdPayments      Payment[]
  payrollRecords       PayrollRecord[]
  permissions          Permission[]
  Quote                Quote[]
  savedFilters         SavedFilter[]
  assignedTasks        Task[]                 @relation("AssignedTasks")
  createdTasks         Task[]                 @relation("CreatedTasks")
  taskAttachments      TaskAttachment[]
  taskComments         TaskComment[]
  managedTeams         Team[]                 @relation("TeamManager")
  approvedTimeEntries  TimeEntry[]            @relation("ApprovedTimeEntries")
  timeEntries          TimeEntry[]
  company              Company?               @relation(fields: [companyId], references: [id])
  workerCalendarConfig WorkerCalendarConfig[]
  workerMonthlyStats   WorkerMonthlyStats[]
  tasks                Task[]                 @relation("TaskAssignees")
  memberOfTeams        Team[]                 @relation("TeamMembers")
  departmentMemberships UserDepartment[]

  @@index([companyId])
  @@index([employeeCode])
}

model UserDepartment {
  id         String     @id @default(cuid())
  userId     String
  department Department
  isManager  Boolean    @default(false)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, department])
  @@index([department])
}

model Project {
  id              String                  @id @default(cuid())
  code            String                  @unique
  name            String
  year            Int
  department      Department              @default(OTHER)
  isActive        Boolean                 @default(true)
  companyId       String?
  clientId        String?
  hourlyRate      Decimal?                @db.Decimal(10, 2)
  Chat            Chat[]
  documents       Document[]
  events          Event[]
  expenses        Expense[]
  folders         Folder[]
  invoices        Invoice[]
  client          Client?                 @relation(fields: [clientId], references: [id])
  company         Company?                @relation(fields: [companyId], references: [id])
  hoursAggregates ProjectHoursAggregate[]
  tasks           Task[]
  teams           Team[]                  @relation("TeamProject")
  timeEntries     TimeEntry[]

  @@index([companyId])
  @@index([clientId])
}

model Client {
  id           String          @id @default(cuid())
  name         String
  email        String?
  phone        String?
  companyName  String?
  companyId    String?
  address      String?
  industry     String?
  website      String?
  notes        String?
  status       ClientStatus    @default(ACTIVE)
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  ownerCompany Company?        @relation(fields: [companyId], references: [id])
  contacts     ClientContact[]
  invoices     Invoice[]
  leads        Lead[]
  projects     Project[]
  Quote        Quote[]

  @@index([companyId])
}

model ClientContact {
  id         String   @id @default(cuid())
  clientId   String
  name       String
  email      String?
  phone      String?
  position   String?
  isPrimary  Boolean  @default(false)
  accessCode String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  client     Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

model Lead {
  id                String    @id @default(cuid())
  title             String
  description       String?
  value             Decimal   @default(0) @db.Decimal(12, 2)
  currency          String    @default("EUR")
  probability       Int       @default(0)
  expectedCloseDate DateTime?
  stage             LeadStage @default(NEW)
  companyId         String
  clientId          String?
  assignedToId      String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  assignedTo        User?     @relation(fields: [assignedToId], references: [id])
  client            Client?   @relation(fields: [clientId], references: [id])
  ownerCompany      Company   @relation(fields: [companyId], references: [id])
  Quote             Quote[]

  @@index([companyId])
  @@index([clientId])
  @@index([assignedToId])
  @@index([stage])
}

model TimeEntry {
  id              String          @id @default(cuid())
  userId          String
  projectId       String
  date            DateTime        @db.Date
  hours           Float
  startTime       String?
  endTime         String?
  notes           String?
  status          TimeEntryStatus @default(DRAFT)
  submittedAt     DateTime?
  approvedAt      DateTime?
  approvedById    String?
  rejectionReason String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @default(now()) @updatedAt
  approvedBy      User?           @relation("ApprovedTimeEntries", fields: [approvedById], references: [id])
  project         Project         @relation(fields: [projectId], references: [id])
  user            User            @relation(fields: [userId], references: [id])

  @@index([userId, date])
  @@index([projectId])
  @@index([status])
  @@index([userId, status])
}

model Task {
  id             String              @id @default(cuid())
  title          String
  description    String?
  status         TaskStatus          @default(PENDING)
  priority       TaskPriority        @default(MEDIUM)
  type           TaskType            @default(GENERAL)
  dueDate        DateTime?
  projectId      String?
  assignedToId   String?
  createdById    String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  completedAt    DateTime?
  assignedTo     User?               @relation("AssignedTasks", fields: [assignedToId], references: [id])
  createdBy      User                @relation("CreatedTasks", fields: [createdById], references: [id])
  project        Project?            @relation(fields: [projectId], references: [id])
  attachments    TaskAttachment[]
  checklistItems TaskChecklistItem[]
  comments       TaskComment[]
  labels         TaskLabel[]
  assignees      User[]              @relation("TaskAssignees")

  @@index([assignedToId])
  @@index([createdById])
  @@index([projectId])
  @@index([status])
  @@index([dueDate])
}

model TaskComment {
  id        String   @id @default(cuid())
  content   String
  taskId    String
  userId    String
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([taskId])
  @@index([userId])
}

model TaskAttachment {
  id           String   @id @default(cuid())
  taskId       String
  fileName     String
  fileUrl      String
  fileSize     Int
  mimeType     String
  uploadedById String
  createdAt    DateTime @default(now())
  task         Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])

  @@index([taskId])
}

model TaskLabel {
  id        String   @id @default(cuid())
  taskId    String
  name      String
  color     String   @default("#3B82F6")
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model TaskChecklistItem {
  id        String   @id @default(cuid())
  taskId    String
  text      String
  completed Boolean  @default(false)
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([order])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  senderId  String?
  sender    User?            @relation("SentNotifications", fields: [senderId], references: [id])
  user      User             @relation(fields: [userId], references: [id])

  @@index([userId, isRead])
  @@index([createdAt])
}

model Document {
  id           String            @id @default(cuid())
  name         String
  description  String?
  fileName     String
  fileSize     Int
  fileType     String
  filePath     String
  version      Int               @default(1)
  projectId    String?
  folderId     String?
  uploadedById String
  isPublic     Boolean           @default(false)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  folder       Folder?           @relation(fields: [folderId], references: [id])
  project      Project?          @relation(fields: [projectId], references: [id])
  uploadedBy   User              @relation("UploadedDocuments", fields: [uploadedById], references: [id])
  shares       DocumentShare[]
  versions     DocumentVersion[]

  @@index([projectId])
  @@index([folderId])
  @@index([uploadedById])
  @@index([createdAt])
}

model DocumentVersion {
  id           String   @id @default(cuid())
  documentId   String
  version      Int
  fileName     String
  filePath     String
  fileSize     Int
  uploadedById String
  changes      String?
  createdAt    DateTime @default(now())
  document     Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])

  @@index([documentId])
  @@index([createdAt])
}

model Folder {
  id          String     @id @default(cuid())
  name        String
  description String?
  projectId   String?
  parentId    String?
  createdById String
  createdAt   DateTime   @default(now())
  documents   Document[]
  createdBy   User       @relation(fields: [createdById], references: [id])
  parent      Folder?    @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  children    Folder[]   @relation("FolderHierarchy")
  project     Project?   @relation(fields: [projectId], references: [id])

  @@index([projectId])
  @@index([parentId])
  @@index([createdById])
}

model DocumentShare {
  id              String      @id @default(cuid())
  documentId      String
  sharedWithId    String?
  sharedWithEmail String?
  accessLevel     AccessLevel @default(VIEW)
  expiresAt       DateTime?
  createdAt       DateTime    @default(now())
  document        Document    @relation(fields: [documentId], references: [id], onDelete: Cascade)
  sharedWith      User?       @relation(fields: [sharedWithId], references: [id])

  @@index([documentId])
  @@index([sharedWithId])
}

model Event {
  id             String          @id @default(cuid())
  title          String
  description    String?
  startDate      DateTime
  endDate        DateTime
  allDay         Boolean         @default(false)
  location       String?
  type           EventType       @default(MEETING)
  recurrenceRule String?
  userId         String
  projectId      String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  project        Project?        @relation(fields: [projectId], references: [id])
  user           User            @relation(fields: [userId], references: [id])
  attendees      EventAttendee[]

  @@index([userId])
  @@index([projectId])
  @@index([startDate])
}

model EventAttendee {
  id      String         @id @default(cuid())
  eventId String
  userId  String
  status  AttendeeStatus @default(PENDING)
  event   Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user    User           @relation(fields: [userId], references: [id])

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model Chat {
  id        String       @id @default(cuid())
  type      ChatType     @default(PROJECT)
  name      String?
  image     String?
  projectId String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  project   Project?     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  members   ChatMember[]
  messages  Message[]

  @@index([projectId])
}

model ChatMember {
  id         String   @id @default(cuid())
  chatId     String
  userId     String
  isFavorite Boolean  @default(false)
  role       String   @default("MEMBER")
  lastRead   DateTime @default(now())
  joinedAt   DateTime @default(now())
  chat       Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user       User     @relation("ChatMemberships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([chatId, userId])
  @@index([userId])
}

model Message {
  id          String    @id @default(cuid())
  content     String
  chatId      String
  authorId    String
  replyToId   String?
  attachments Json?
  mentions    String[]
  isEdited    Boolean   @default(false)
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  author      User      @relation("AuthoredMessages", fields: [authorId], references: [id])
  chat        Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade)
  replyTo     Message?  @relation("MessageReplies", fields: [replyToId], references: [id])
  replies     Message[] @relation("MessageReplies")

  @@index([chatId, createdAt])
  @@index([authorId])
}

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String
  companyId  String?
  action     String
  entityType String?
  entityId   String?
  details    String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  company    Company? @relation(fields: [companyId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([companyId])
  @@index([createdAt])
  @@index([action])
}

model Expense {
  id           String          @id @default(cuid())
  description  String
  amount       Decimal         @db.Decimal(12, 2)
  currency     String          @default("EUR")
  date         DateTime
  category     ExpenseCategory @default(OTHER)
  companyId    String?
  projectId    String?
  userId       String
  receiptUrl   String?
  status       ExpenseStatus   @default(PENDING)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  ownerCompany Company?        @relation(fields: [companyId], references: [id])
  project      Project?        @relation(fields: [projectId], references: [id])
  user         User            @relation(fields: [userId], references: [id])

  @@index([companyId])
  @@index([projectId])
  @@index([userId])
}

model SystemSetting {
  key         String  @id
  value       String
  description String?
}

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  companyId   String
  managerId   String?
  projectId   String?
  chatId      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  company     Company  @relation(fields: [companyId], references: [id])
  manager     User?    @relation("TeamManager", fields: [managerId], references: [id])
  project     Project? @relation("TeamProject", fields: [projectId], references: [id])
  members     User[]   @relation("TeamMembers")

  @@index([companyId])
  @@index([managerId])
  @@index([projectId])
}

model Permission {
  id        String   @id @default(cuid())
  userId    String
  resource  String
  action    String
  granted   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, resource, action])
  @@index([userId])
}

model DepartmentPermission {
  id         String     @id @default(cuid())
  department Department
  resource   String
  action     String
  granted    Boolean    @default(true)
  scope      String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@unique([department, resource, action])
  @@index([department])
}

model CompanySettings {
  id                 String   @id @default(cuid())
  companyId          String   @unique
  canCreateUsers     Boolean  @default(true)
  canDeleteUsers     Boolean  @default(true)
  canChangeRoles     Boolean  @default(true)
  canAccessInvoicing Boolean  @default(true)
  canAccessReports   Boolean  @default(true)
  canExportData      Boolean  @default(true)
  canViewAuditLogs   Boolean  @default(true)
  canCreateGuests    Boolean  @default(true)
  modulesEnabled     String[] @default(["projects", "tasks", "documents", "hours", "expenses", "invoices", "crm", "analytics"])
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  company            Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model Invoice {
  id          String        @id @default(cuid())
  number      String        @unique
  date        DateTime      @default(now())
  dueDate     DateTime
  status      InvoiceStatus @default(DRAFT)
  companyId   String?
  clientId    String
  projectId   String?
  subtotal    Decimal       @default(0) @db.Decimal(12, 2)
  taxAmount   Decimal       @default(0) @db.Decimal(12, 2)
  total       Decimal       @default(0) @db.Decimal(12, 2)
  currency    String        @default("EUR")
  paidAmount  Decimal       @default(0) @db.Decimal(12, 2)
  balance     Decimal       @default(0) @db.Decimal(12, 2)
  notes       String?
  terms       String?
  createdById String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  issuedAt    DateTime?
  paidAt      DateTime?
  client      Client        @relation(fields: [clientId], references: [id])
  company     Company?      @relation(fields: [companyId], references: [id])
  createdBy   User          @relation(fields: [createdById], references: [id])
  project     Project?      @relation(fields: [projectId], references: [id])
  items       InvoiceItem[]
  payments    Payment[]

  @@index([companyId])
  @@index([clientId])
  @@index([projectId])
  @@index([status])
  @@index([dueDate])
  @@index([number])
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String
  quantity    Decimal @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(12, 2)
  taxRate     Decimal @default(0) @db.Decimal(5, 2)
  subtotal    Decimal @db.Decimal(12, 2)
  taxAmount   Decimal @db.Decimal(12, 2)
  total       Decimal @db.Decimal(12, 2)
  order       Int     @default(0)
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Payment {
  id          String        @id @default(cuid())
  amount      Decimal       @db.Decimal(12, 2)
  date        DateTime      @default(now())
  method      PaymentMethod @default(TRANSFER)
  reference   String?
  notes       String?
  invoiceId   String
  createdById String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdBy   User          @relation(fields: [createdById], references: [id])
  invoice     Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([date])
}

model Product {
  id          String      @id @default(cuid())
  companyId   String
  name        String
  description String?
  sku         String?
  type        ProductType @default(SERVICE)
  category    String?
  price       Decimal     @default(0) @db.Decimal(12, 2)
  cost        Decimal?    @db.Decimal(12, 2)
  taxRate     Decimal     @default(21) @db.Decimal(5, 2)
  unit        String      @default("unidad")
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([sku])
  @@index([type])
  @@index([isActive])
}

model TaxRate {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  rate        Decimal  @db.Decimal(5, 2)
  description String?
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([isDefault])
}

model Quote {
  id          String      @id @default(cuid())
  number      String      @unique
  status      QuoteStatus @default(DRAFT)
  validUntil  DateTime
  companyId   String
  clientId    String
  leadId      String?
  subtotal    Decimal     @default(0) @db.Decimal(12, 2)
  taxAmount   Decimal     @default(0) @db.Decimal(12, 2)
  total       Decimal     @default(0) @db.Decimal(12, 2)
  notes       String?
  terms       String?
  createdById String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  sentAt      DateTime?
  acceptedAt  DateTime?
  rejectedAt  DateTime?
  convertedAt DateTime?
  client      Client      @relation(fields: [clientId], references: [id])
  company     Company     @relation(fields: [companyId], references: [id])
  createdBy   User        @relation(fields: [createdById], references: [id])
  lead        Lead?       @relation(fields: [leadId], references: [id])
  items       QuoteItem[]

  @@index([companyId])
  @@index([clientId])
  @@index([leadId])
  @@index([status])
  @@index([number])
}

model QuoteItem {
  id          String  @id @default(cuid())
  quoteId     String
  description String
  quantity    Decimal @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(12, 2)
  taxRate     Decimal @default(0) @db.Decimal(5, 2)
  subtotal    Decimal @db.Decimal(12, 2)
  taxAmount   Decimal @db.Decimal(12, 2)
  total       Decimal @db.Decimal(12, 2)
  order       Int     @default(0)
  quote       Quote   @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

model SavedFilter {
  id        String   @id @default(cuid())
  userId    String
  page      String
  name      String
  filters   Json
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([page])
}

model Holiday {
  id        String   @id @default(cuid())
  companyId String?
  date      DateTime @db.Date
  name      String
  type      String   @default("NATIONAL")
  year      Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, date])
  @@index([companyId])
  @@index([year])
}

model HoursControlSettings {
  id                    String   @id @default("default")
  companyId             String?  @unique
  defaultDailyHours     Float    @default(8.0)
  lockAfterDays         Int      @default(30)
  reminderThresholdDays Int      @default(3)
  approvalFrequency     String   @default("none")
  calculationMode       String   @default("laborables")
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model CalendarItem {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String?
  date        DateTime @db.Date
  allDay      Boolean  @default(true)
  color       String?  @default("#8b5cf6")
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([date])
}

model WorkerCalendarConfig {
  id              String     @id @default(cuid())
  userId          String
  year            Int?
  month           Int?
  dailyHours      Float      @default(8.0)
  workMonday      Boolean    @default(true)
  workTuesday     Boolean    @default(true)
  workWednesday   Boolean    @default(true)
  workThursday    Boolean    @default(true)
  workFriday      Boolean    @default(true)
  workSaturday    Boolean    @default(false)
  workSunday      Boolean    @default(false)
  nonWorkingDates DateTime[] @db.Date
  notes           String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year, month])
  @@index([userId])
  @@index([year, month])
}

model WorkerMonthlyStats {
  id                 String    @id @default(cuid())
  userId             String
  year               Int
  month              Int
  workingDays        Int       @default(0)
  expectedHours      Float     @default(0)
  totalHours         Float     @default(0)
  approvedHours      Float     @default(0)
  pendingHours       Float     @default(0)
  difference         Float     @default(0)
  compliancePercent  Float     @default(0)
  lastEntryDate      DateTime? @db.Date
  daysWithEntries    Int       @default(0)
  daysWithoutEntries Int       @default(0)
  calculatedAt       DateTime  @default(now())
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year, month])
  @@index([userId])
  @@index([year, month])
}

model ProjectHoursAggregate {
  id               String   @id @default(cuid())
  projectId        String
  year             Int
  month            Int?
  totalHours       Float    @default(0)
  approvedHours    Float    @default(0)
  pendingHours     Float    @default(0)
  totalCost        Decimal? @db.Decimal(12, 2)
  contributorCount Int      @default(0)
  calculatedAt     DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  project          Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, year, month])
  @@index([projectId])
  @@index([year, month])
}

model WorkerReportingStatus {
  id                   String    @id @default(cuid())
  userId               String    @unique
  lastEntryDate        DateTime? @db.Date
  daysSinceLastEntry   Int       @default(0)
  currentMonthExpected Float     @default(0)
  currentMonthActual   Float     @default(0)
  currentMonthDiff     Float     @default(0)
  ytdExpectedHours     Float     @default(0)
  ytdActualHours       Float     @default(0)
  ytdDifference        Float     @default(0)
  needsAttention       Boolean   @default(false)
  hasPendingApprovals  Boolean   @default(false)
  calculatedAt         DateTime  @default(now())
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([lastEntryDate])
  @@index([needsAttention])
}

model Absence {
  id            String        @id @default(cuid())
  userId        String
  type          AbsenceType
  startDate     DateTime      @db.Date
  endDate       DateTime      @db.Date
  totalDays     Float
  status        AbsenceStatus @default(PENDING)
  reason        String?
  approvedById  String?
  approvedAt    DateTime?
  rejectionNote String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  approvedBy    User?         @relation("ApprovedAbsences", fields: [approvedById], references: [id])
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([startDate, endDate])
  @@index([status])
  @@index([type])
}

model PayrollRecord {
  id         String        @id @default(cuid())
  userId     String
  period     String
  baseSalary Decimal       @db.Decimal(10, 2)
  overtime   Decimal       @default(0) @db.Decimal(10, 2)
  bonuses    Decimal       @default(0) @db.Decimal(10, 2)
  deductions Decimal       @default(0) @db.Decimal(10, 2)
  netSalary  Decimal       @db.Decimal(10, 2)
  status     PayrollStatus @default(DRAFT)
  paidAt     DateTime?
  notes      String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, period])
  @@index([period])
  @@index([status])
}

enum TimeEntryStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum Role {
  SUPERADMIN
  ADMIN
  MANAGER
  WORKER
  GUEST
}

enum Department {
  CIVIL_DESIGN
  ELECTRICAL
  INSTRUMENTATION
  ADMINISTRATION
  IT
  ECONOMIC
  MARKETING
  OTHER
}

enum PresenceStatus {
  AVAILABLE
  BUSY
  DO_NOT_DISTURB
  BE_RIGHT_BACK
  AWAY
  OFFLINE
}

enum ContractType {
  INDEFINIDO
  TEMPORAL
  OBRA_SERVICIO
  PRACTICAS
  FORMACION
}

enum AbsenceType {
  VACATION
  SICK
  PERSONAL
  MATERNITY
  PATERNITY
  UNPAID
  OTHER
}

enum AbsenceStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PayrollStatus {
  DRAFT
  PROCESSING
  COMPLETED
  PAID
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskType {
  GENERAL
  PROJECT
  MEETING
  REVIEW
  MAINTENANCE
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_COMPLETED
  TASK_COMMENT
  TASK_DUE_SOON
  HOURS_APPROVED
  PROJECT_ASSIGNED
  SYSTEM
}

enum AccessLevel {
  VIEW
  DOWNLOAD
  EDIT
}

enum EventType {
  MEETING
  DEADLINE
  REMINDER
  HOLIDAY
  OTHER
}

enum AttendeeStatus {
  PENDING
  ACCEPTED
  DECLINED
  TENTATIVE
}

enum ChatType {
  PROJECT
  DIRECT
  GROUP
}

enum LeadStage {
  NEW
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  PROSPECT
}

enum ExpenseCategory {
  TRAVEL
  MEALS
  EQUIPMENT
  SOFTWARE
  OFFICE
  OTHER
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum InvoiceStatus {
  DRAFT
  SENT
  OVERDUE
  PAID
  CANCELLED
  PARTIAL
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  CHEQUE
  OTHER
}

enum ProductType {
  PRODUCT
  SERVICE
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED
}
